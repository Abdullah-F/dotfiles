#!/usr/bin/env ruby
# Runs minitest tests using RSpec's test runner, so that I can use the documentation formatter, fail-fast flag, etc
# Inspired by
# https://github.com/rspec/rspec-core/issues/1786
# https://gist.github.com/e2/bcd2be81b4ac28c85ea0

# presumably this is loose enough to not whine all the time, but tight enough to not break
gem 'rspec',    '~> 3.0'
gem 'minitest', '~> 5.0'

require 'rspec/core'
require 'minitest'

# Seems you have to give it as a CLI argument, otherwise it will overwrite your configuration when it processes CLI args
ARGV.unshift '--pattern', '{spec,test}/**/*_{spec,test}.rb'


RSpec.configure do |c|
  c.filter_gems_from_backtrace 'minitest'
  c.disable_monkey_patching!
end

def RSpec.describe_minitest_class(klass)
  group = RSpec.describe klass.inspect.sub(/Test$/, '')
  klass.runnable_methods.each do |method_name|

    rspec_name = method_name.to_s.sub(/^test_/, '').tr('_', ' ')

    example = group.example rspec_name do
      instance = Minitest.run_one_method klass, method_name
      next if instance.passed?
      pending 'skipped' if instance.skipped?
      raise instance.failure
    end

    # can't think of any reason a test wouldn't have a file/line, but still figure I should check
    file, line = klass.instance_method(method_name).source_location
    if file && line
      example.metadata[:file_path]          = file
      example.metadata[:line_number]        = line
      example.metadata[:location]           = "#{file}:#{line}"
      example.metadata[:absolute_file_path] = File.expand_path(file)
    end
  end
end


class MRspecRunner < RSpec::Core::Runner
  def setup(*)
    super.tap { import_minitest }
  end

  def import_minitest
    # we're not using the reporter, but some plugins, (eg minitest/pride) expect it to be there
    Minitest.reporter = Minitest::CompositeReporter.new
    Minitest.load_plugins
    Minitest.init_plugins Minitest.process_args([])

    Minitest::Runnable.runnables.each do |klass|
      RSpec.describe_minitest_class(klass)
    end
  end
end

MRspecRunner.autorun
